<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pedidos - Rotiser√≠a</title>
    {% include '_header_css.html' %}
    <style>
        :root{--bg:#1e1e1e;--card:#2d2d2d;--fg:#e0e0e0;--muted:#a0a0a0;--accent:#0e639c;--success:#4caf50;--border:#444}
        *{box-sizing:border-box}
        body{font-family:Segoe UI,system-ui,Arial;min-height:100vh;background:var(--bg);color:var(--fg);margin:0}
        header{background:var(--card);padding:12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
        .nav{display:flex;gap:8px;align-items:center}
        .nav a{color:var(--fg);background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:6px;text-decoration:none}
        main{padding:16px;max-width:1000px;margin:0 auto}
        .orders{display:flex;flex-direction:column;gap:12px}
        .order-card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:8px}
        .order-header{display:flex;justify-content:space-between;align-items:center}
        .order-wait{font-size:0.85rem;color:var(--accent);margin-top:6px;text-align:right}
        .order-code{font-weight:700}
        .order-customer{color:var(--muted);font-size:0.95rem}
        .order-body{margin-top:8px}
        .order-item{display:flex;justify-content:flex-start;padding:4px 0;position:relative;padding-right:72px}
        .order-item .order-item-name{flex:1 1 auto;min-width:0}
        .order-item .order-item-price{position:absolute;right:0.5rem;top:50%;transform:translateY(-50%);white-space:nowrap;color:var(--muted)}
        .item-qty{font-weight:600;margin-right:6px}
        .order-total{margin-top:8px;color:var(--muted)}
        .order-actions{margin-top:8px}
        .btn-primary{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
        .btn-secondary{background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:6px;color:var(--fg);text-decoration:none}
        .empty-state{text-align:center;padding:3rem;color:var(--muted)}
        .toast{position:fixed;bottom:1.5rem;right:1.5rem;padding:.75rem 1.25rem;background:var(--success);color:#fff;border-radius:6px;transform:translateY(100px);opacity:0;transition:all .25s}
        .toast.show{transform:translateY(0);opacity:1}
        
    </style>
</head>
<body>
    {% include '_header.html' %}

    <main>
        <div style="display:flex;align-items:center;gap:12px;margin:8px 16px">
            <label style="color:var(--muted);font-size:0.95rem">Zoom p√°gina
                <input id="pageZoom" type="range" min="0.6" max="1.8" step="0.02" value="1" style="width:240px;margin-left:8px">
            </label>
            <div id="pageZoomValue" style="color:var(--muted);font-size:0.95rem">100%</div>
        </div>
        <div class="orders-layout" style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 320px;gap:16px;padding:0 16px;transform-origin:0 0">
            <section>
                <div id="ordersContainer" class="orders"></div>
                <div id="empty" class="empty-state" style="display:none">Esperando pedidos...</div>
            </section>
            <aside style="">
                <h3 style="margin:0 0 8px;color:var(--muted);font-weight:700">Historial (Finalizados)</h3>
                <div id="historyContainer" class="history-list" style="display:block;max-height:70vh;overflow:auto;padding-right:6px"></div>
                <div id="historyEmpty" class="empty-state" style="display:none">No hay pedidos finalizados.</div>
            </aside>
        </div>
    </main>


    <div id="toast" class="toast" style="display:none"></div>

    <script>
        // Pedidos page script (single, clean implementation)
        const ordersContainer = document.getElementById('ordersContainer');
        const emptyNode = document.getElementById('empty');
        const historyContainer = document.getElementById('historyContainer');
        const historyEmpty = document.getElementById('historyEmpty');
        const toast = document.getElementById('toast');
        let lastOrderCount = 0;

        async function safeFetch(path, opts){
            try{const r = await fetch(path, opts); if(!r.ok) return null; return await r.json()}catch(e){return null}
        }

        function showToast(msg){ toast.textContent = msg; toast.style.display = 'block'; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(()=>toast.style.display='none',300) },1800) }

        function escapeHtml(text){ if(text==null) return ''; const d=document.createElement('div'); d.textContent = text; return d.innerHTML }

        function renderOrders(orders){
            if(!Array.isArray(orders) || orders.length===0){ ordersContainer.innerHTML=''; emptyNode.style.display='block'; return }
            emptyNode.style.display='none';
            const sorted = [...orders].reverse();
            ordersContainer.innerHTML = sorted.map((order,i)=>{
                const time = (order.timestamp||'').split(' ')[1]||'';
                const status = order.status || 'pending';
                const orderId = order.id ?? i;
                const orderCode = order.code || `P${String(orderId).padStart(3,'0')}`;
                const itemsHtml = Object.entries(order.items||{}).map(([name,d])=>{
                    let qty = 0;
                    let price = 0;
                    if(typeof d === 'object'){
                        qty = d.quantity || 0;
                        price = d.price || d.per_unit || (d.line_total && (d.quantity? Math.round(d.line_total / (d.quantity||1)) : 0)) || 0;
                    } else {
                        qty = d || 0;
                        price = 0; // fallback: unknown per-unit price for legacy format
                    }
                    return `<div class="order-item"><span class="order-item-name"><span class="item-qty">${qty}x</span> ${escapeHtml(name)}</span><span class="order-item-price">$${(price).toLocaleString()}</span></div>`
                }).join('');
                const actionBtn = status==='pending' ? `<button class="btn-primary" onclick="updateStatus(${orderId},'finished')">‚úî Finalizar</button>` : '';
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-code">${orderCode}</div>
                                <div class="order-customer">${escapeHtml(order.customer)}</div>
                                ${order.address? `<div class="order-address" style="color:var(--muted);font-size:0.9rem;margin-top:4px">üìç ${escapeHtml(order.address)}</div>` : ''}
                            </div>
                            <div style="text-align:right">
                                <div class="order-time" title="Hora de pedido">Pedido: ${time}</div>
                                <div class="order-wait" data-ts="${escapeHtml(order.timestamp||'')}" title="Tiempo transcurrido desde el pedido">Tiempo: ${formatElapsed(order.timestamp||'')}</div>
                            </div>
                        </div>
                        <div class="order-body">
                            ${itemsHtml}
                            ${order.notes?`<div class="order-notes">üìù ${escapeHtml(order.notes)}</div>`:''}
                            ${order.address? `<div class="order-address" style="color:var(--muted);font-size:0.95rem;margin-top:6px">üìç ${escapeHtml(order.address)}</div>` : ''}
                            <div class="order-total">Total: $${(order.total||0).toLocaleString()}</div>
                            <div class="order-actions">${actionBtn}</div>
                        </div>
                    </div>`
            }).join('')
        }

        function renderHistory(orders){
            const finished = Array.isArray(orders) ? orders.filter(o => (o.status && o.status !== 'pending')) : [];
            if(finished.length === 0){ historyContainer.innerHTML=''; historyEmpty.style.display='block'; return }
            historyEmpty.style.display='none';
            const sorted = [...finished].reverse();
            historyContainer.innerHTML = sorted.map((order,i)=>{
                const time = (order.timestamp||'').split(' ')[1]||'';
                const orderCode = order.code || `P${String(order.id??i).padStart(3,'0')}`;
                const total = (order.total||0).toLocaleString();
                // items HTML (compact)
                const itemsHtml = Object.entries(order.items||{}).map(([name,d])=>{
                    let qty = 0;
                    let price = 0;
                    if(typeof d === 'object'){
                        qty = d.quantity || 0;
                        price = d.price || d.per_unit || (d.line_total && (d.quantity? Math.round(d.line_total / (d.quantity||1)) : 0)) || 0;
                    } else {
                        qty = d || 0;
                        price = 0;
                    }
                    return `<div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--muted);padding:2px 0"><div>${escapeHtml(name)} <span style="opacity:.9">√ó${qty}</span></div><div>$${(price).toLocaleString()}</div></div>`
                }).join('');
                const duration = order.finished_at ? formatDuration(order.timestamp, order.finished_at) : '';
                // For finished orders show placed time, finished time and duration
                const finishedTime = order.finished_at ? (order.finished_at.split(' ')[1]||'') : '';
                return `
                    <div class="order-card" style="padding:8px;margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div style="font-weight:700">${escapeHtml(orderCode)}</div>
                            <div style="color:var(--muted);font-size:0.9rem">Pedido: ${escapeHtml(time)}</div>
                        </div>
                        <div style="margin-top:6px;color:var(--muted);font-size:0.95rem">${escapeHtml(order.customer||'--')}</div>
                        ${order.address? `<div style="margin-top:6px;color:var(--muted);font-size:0.95rem">üìç ${escapeHtml(order.address)}</div>` : ''}
                        <div style="margin-top:6px;color:var(--muted)">Total: $${total}</div>
                        ${itemsHtml ? `<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:6px">${itemsHtml}</div>` : ''}
                        ${duration ? `<div style="margin-top:6px;font-size:0.85rem;color:var(--accent)">Tiempo: ${duration}</div>` : ''}
                        ${finishedTime ? `<div style="margin-top:4px;color:var(--muted);font-size:0.85rem">Finalizado: ${escapeHtml(finishedTime)}</div>` : ''}
                    </div>`
            }).join('')
        }

        async function loadOrders(){
            const orders = await safeFetch('/api/history');
            if(!orders){ console.error('Failed to load orders'); return }
            if(orders.length>lastOrderCount && lastOrderCount>0){ showToast('üÜï ¬°Nuevo pedido!') }
            lastOrderCount = orders.length;
            renderOrders(orders.filter(o=>!o.status || o.status==='pending'));
            renderHistory(orders);
            // Update timers immediately after rendering
            updateTimers();
        }

        async function updateStatus(orderId,status){
            try{
                const res = await fetch(`/api/order/${orderId}/status`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status})});
                if(res.ok){ loadOrders(); showToast('üöö Pedido actualizado') }
            }catch(e){console.error(e)}
        }

        // init
        loadOrders(); setInterval(loadOrders,3000);

        // Timer utilities: parse, format, and update elapsed timers
        function parseTimestamp(ts){
            if(!ts) return null;
            if(ts instanceof Date) return ts;
            if(typeof ts === 'number') return new Date(ts);
            const s = String(ts).trim();
            if(s.includes('T') || /\d{4}-\d{2}-\d{2}/.test(s)){
                const iso = s.includes('T') ? s : s.replace(' ', 'T');
                const d = new Date(iso);
                if(!isNaN(d)) return d;
            }
            const timeOnly = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2})(?:\.(\d+))?)?$/);
            if(timeOnly){
                const now = new Date();
                const hh = Number(timeOnly[1]);
                const mm = Number(timeOnly[2]);
                const ss = Number(timeOnly[3]||0);
                const ms = Number((timeOnly[4]||'0').padEnd(3,'0'));
                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, ss, ms);
            }
            const fallback = new Date(s);
            return isNaN(fallback) ? null : fallback;
        }

        function formatElapsed(ts){
            const d = parseTimestamp(ts);
            if(!d) return '';
            const diff = Math.floor((Date.now() - d.getTime())/1000);
            if(diff < 0) return '0s';
            const hours = Math.floor(diff/3600);
            const minutes = Math.floor((diff%3600)/60);
            const seconds = diff%60;
            if(hours>0) return `${hours}h ${String(minutes).padStart(2,'0')}m ${String(seconds).padStart(2,'0')}s`;
            if(minutes>0) return `${minutes}m ${String(seconds).padStart(2,'0')}s`;
            return `${seconds}s`;
        }

        function formatDuration(startTs, endTs){
            const s = parseTimestamp(startTs);
            const e = parseTimestamp(endTs) || new Date();
            if(!s || !e) return '';
            let diff = Math.floor((e.getTime() - s.getTime())/1000);
            if(diff < 0) diff = 0;
            const hours = Math.floor(diff/3600);
            const minutes = Math.floor((diff%3600)/60);
            const seconds = diff%60;
            if(hours>0) return `${hours}h ${String(minutes).padStart(2,'0')}m ${String(seconds).padStart(2,'0')}s`;
            if(minutes>0) return `${minutes}m ${String(seconds).padStart(2,'0')}s`;
            return `${seconds}s`;
        }

        function updateTimers(){
            document.querySelectorAll('.order-wait').forEach(el=>{
                const ts = el.getAttribute('data-ts');
                el.textContent = formatElapsed(ts);
            });
        }

        // refresh timers every second
        setInterval(updateTimers,1000);

        // Page zoom slider (orders page only) ‚Äî persists value and supports Ctrl+wheel
        (function(){
            const slider = document.getElementById('pageZoom');
            if(!slider) return;
            const label = document.getElementById('pageZoomValue');
            const layout = document.querySelector('.orders-layout');
            const apply = (v) => {
                // apply transform scale to the orders-layout only
                const val = Number(v) || 1;
                if(layout) layout.style.transform = `scale(${val})`;
                if(label) label.textContent = Math.round(val*100) + '%';
            };
            const saved = localStorage.getItem('orders.pageZoom');
            const start = saved ? Number(saved) : Number(slider.value || 1);
            slider.value = start;
            apply(start);
            slider.addEventListener('input', (e)=> apply(e.target.value));
            slider.addEventListener('change', (e)=> localStorage.setItem('orders.pageZoom', e.target.value));

            window.addEventListener('wheel', (e)=>{
                if(e.ctrlKey){
                    e.preventDefault();
                    const delta = -e.deltaY * 0.0015;
                    let cur = Number(slider.value) || 1;
                    let nv = Math.min(Math.max(cur + delta, Number(slider.min)), Number(slider.max));
                    nv = Math.round(nv*100)/100;
                    slider.value = nv;
                    apply(nv);
                    localStorage.setItem('orders.pageZoom', nv);
                }
            }, {passive:false});
        })();
    </script>
    
</body>
</html>
