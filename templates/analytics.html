<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis - Rotiser√≠a</title>
    {% include '_header_css.html' %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --bg-card: #333333;
            --fg: #e0e0e0;
            --fg-muted: #a0a0a0;
            --accent: #0e639c;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --border: #444444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--fg);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            background-color: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--fg);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--bg);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.25rem;
            border: 1px solid var(--border);
        }

        .stat-card h3 {
            font-size: 0.85rem;
            color: var(--fg-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--success);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .chart-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .chart-card h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--fg);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Date Filter */
        .filters {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border);
        }

        .filters h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-row label {
            font-size: 0.9rem;
            color: var(--fg-muted);
        }

        .filter-row input {
            padding: 0.5rem;
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--fg);
            font-size: 0.9rem;
        }

        .filter-row input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--fg-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    {% include '_header.html' %}

    <div class="container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 data-translate="totalOrders">Pedidos Totales</h3>
                <div class="value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <h3 data-translate="totalRevenue">Ingresos Totales</h3>
                <div class="value" id="totalRevenue">$0</div>
            </div>
            <div class="stat-card">
                <h3 data-translate="avgOrderValue">Valor Promedio</h3>
                <div class="value" id="avgOrderValue">$0</div>
            </div>
            <div class="stat-card">
                <h3 data-translate="todayOrders">Pedidos Hoy</h3>
                <div class="value" id="todayOrders">0</div>
            </div>
            <div class="stat-card">
                <h3 data-translate="totalCosts">Costos Totales</h3>
                <div class="value" id="totalCosts">$0</div>
            </div>
            <div class="stat-card">
                <h3 data-translate="totalProfits">Ganancias Totales</h3>
                <div class="value" id="totalProfits">$0</div>
            </div>
            <div class="stat-card">
                <h3 data-translate="profitMargin">Margen de Ganancia</h3>
                <div class="value" id="profitMargin">0%</div>
            </div>
            <div class="stat-card">
                <h3 data-translate="avgProfitPerOrder">Ganancia Promedio x Pedido</h3>
                <div class="value" id="avgProfitPerOrder">$0</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h3 data-translate="dateFilters">üìÖ Filtros de Fecha</h3>
            <div class="filter-row">
                <label data-translate="from" for="startDate">Desde:</label>
                <input type="date" id="startDate" autocomplete="off">
                <label data-translate="to" for="endDate">Hasta:</label>
                <input type="date" id="endDate" autocomplete="off">
                <button type="button" class="btn btn-secondary" id="applyFiltersBtn" data-translate="apply">üîç Aplicar</button>
                <button type="button" class="btn btn-secondary" id="resetFiltersBtn" data-translate="reset">üîÑ Reset</button>
            </div>
            <div class="filter-row">
                <label>
                    <input type="checkbox" id="useDummyData">
                    <span data-translate="useDummyData">üìä Usar Datos de Prueba (300 pedidos/mes)</span>
                </label>
            </div>
            <div class="filter-row" style="margin-top:0.5rem; align-items:center;">
                <label>
                    <input type="checkbox" id="autoRefreshToggle">
                    <span data-translate="autoRefresh">üîÅ Auto-refresh</span>
                </label>
                <button type="button" class="btn btn-secondary" id="refreshBtn" style="margin-left:0.75rem;" data-translate="refreshNow">‚ü≥ Refrescar</button>
            </div>
        </div>

        <!-- Profit Configuration -->
        <div class="filters" style="margin-top:1rem;">
            <h3>‚öôÔ∏è Profit Configuration</h3>
            <div class="filter-row">
                <label for="monthlyRent">Monthly Rent:</label>
                <input type="number" id="monthlyRent" step="0.01" min="0" placeholder="0">
                <label for="courierCost">Courier Cost per Order:</label>
                <input type="number" id="courierCost" step="0.01" min="0" placeholder="0">
            </div>
            <div class="filter-row" style="margin-top:0.5rem;">
                <label for="hourlyWage">Hourly Wage:</label>
                <input type="number" id="hourlyWage" step="0.01" min="0" placeholder="0">
                <label for="dailyHours">Daily Hours Worked:</label>
                <input type="number" id="dailyHours" step="0.1" min="0" placeholder="0">
                <button type="button" class="btn btn-secondary" id="applyProfitConfigBtn" style="margin-left:0.5rem;">Save & Apply</button>
                <button type="button" class="btn btn-secondary" id="editProductCogsBtn" style="margin-left:0.5rem;">Edit Product COGS</button>
            </div>
            <div style="margin-top:0.5rem;color:var(--fg-muted);font-size:0.9rem;">Note: Daily Net Profit = Daily Revenue - (Product COGS + Rent/30 + (Hourly Wage * Daily Hours) + Courier Cost * Orders)</div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 data-translate="dailySales">üí∞ Ventas Diarias</h3>
                <div class="chart-container">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3 data-translate="dailyOrders">üìà Pedidos Diarios</h3>
                <div class="chart-container">
                    <canvas id="dailyOrdersChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3 data-translate="costsVsProfits">üí∏ Costos vs Ganancias Diarias</h3>
                <div class="chart-container">
                    <canvas id="dailyCostsProfitsChart"></canvas>
                </div>
            </div>


            <div class="chart-card">
                <h3 data-translate="hourlyOrders">üïê Pedidos por Hora</h3>
                <div class="chart-container">
                    <canvas id="hourlyOrdersChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3 data-translate="popularItems">üçΩÔ∏è Productos M√°s Vendidos</h3>
                <div class="chart-container">
                    <canvas id="popularItemsChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <!-- Chart Modal (for enlarging charts) -->
    <div id="chartModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2000;">
        <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;max-width:90%;max-height:90%;padding:1rem;box-shadow:0 8px 24px rgba(0,0,0,0.5);overflow:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <div id="modalChartTitle" style="font-weight:600;color:var(--fg);"></div>
                <button id="closeChartModal" class="btn btn-secondary">Cerrar</button>
            </div>
            <div id="modalCanvasHolder" style="width:1100px;max-width:calc(100vw - 4rem);height:600px;max-height:calc(100vh - 6rem);">
                <!-- canvas will be moved here when modal opens -->
            </div>
        </div>
    </div>

    <!-- Product COGS Modal -->
    <div id="productCogsModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2100;">
        <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;max-width:900px;width:90%;max-height:80%;padding:1rem;box-shadow:0 8px 24px rgba(0,0,0,0.5);overflow:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <div style="font-weight:600;color:var(--fg);">Edit Product COGS</div>
                <div>
                    <button id="saveProductCogsBtn" class="btn btn-secondary" style="margin-right:0.5rem;">Save</button>
                    <button id="closeProductCogsBtn" class="btn btn-secondary">Close</button>
                </div>
            </div>
            <div id="productCogsContent" style="display:grid;grid-template-columns:1fr 120px;gap:0.5rem;align-items:center;">
                <!-- populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        let analyticsData = null;
        let dailySalesChart, dailyOrdersChart, hourlyOrdersChart, popularItemsChart;
        let dailyCostsProfitsChart;
        const chartInstances = {};

        function getFreshCtx(canvasId) {
            const el = document.getElementById(canvasId);
            if (!el) return null;
            // Prefer reusing the existing canvas context. We ensure charts are destroyed before reuse.
            return el.getContext('2d');
        }

        // Extend translations with analytics-specific terms
        Object.assign(translations.es, {
            title: "üìä An√°lisis de Ventas",
            // Stats cards
            totalOrders: "Pedidos Totales",
            totalRevenue: "Ingresos Totales",
            avgOrderValue: "Valor Promedio",
            todayOrders: "Pedidos Hoy",
            totalCosts: "Costos Totales",
            totalProfits: "Ganancias Totales",
            profitMargin: "Margen de Ganancia",
            avgProfitPerOrder: "Ganancia Promedio x Pedido",
            // Filters
            dateFilters: "üìÖ Filtros de Fecha",
            from: "Desde:",
            to: "Hasta:",
            apply: "üîç Aplicar",
            reset: "üîÑ Reset",
            useDummyData: "üìä Usar Datos de Prueba (300 pedidos/mes)",
            // Chart titles
            dailySales: "üí∞ Ventas Diarias",
            dailyOrders: "üìà Pedidos Diarios",
            costsVsProfits: "üí∏ Costos vs Ganancias Diarias",
            profitMarginChart: "üìä Margen de Ganancia Diario",
            hourlyOrders: "üïê Pedidos por Hora",
            popularItems: "üçΩÔ∏è Productos M√°s Vendidos",
            itemCosts: "üí∞ Costos por Producto",
            itemMargins: "üìà Margen de Ganancia por Producto",
            // Chart labels
            costs: "Costos",
            profits: "Ganancias",
            profitMarginLabel: "Margen de Ganancia (%)",
            totalCostsLabel: "Costos Totales",
            profitMarginPercent: "Margen de Ganancia (%)",
            dailySalesLabel: "Ventas Diarias ($)",
            dailyOrdersLabel: "Pedidos Diarios",
            hourlyOrdersLabel: "Pedidos por Hora"
            ,
            autoRefresh: "üîÅ Auto-refresh",
            refreshNow: "‚ü≥ Refrescar"
        });

        Object.assign(translations.en, {
            title: "üìä Sales Analytics",
            // Stats cards
            totalOrders: "Total Orders",
            totalRevenue: "Total Revenue",
            avgOrderValue: "Average Value",
            todayOrders: "Orders Today",
            totalCosts: "Total Costs",
            totalProfits: "Total Profits",
            profitMargin: "Profit Margin",
            avgProfitPerOrder: "Avg Profit per Order",
            // Filters
            dateFilters: "üìÖ Date Filters",
            from: "From:",
            to: "To:",
            apply: "üîç Apply",
            reset: "üîÑ Reset",
            useDummyData: "üìä Use Test Data (300 orders/month)",
            // Chart titles
            dailySales: "üí∞ Daily Sales",
            dailyOrders: "üìà Daily Orders",
            costsVsProfits: "üí∏ Daily Costs vs Profits",
            profitMarginChart: "üìä Daily Profit Margin",
            hourlyOrders: "üïê Orders by Hour",
            popularItems: "üçΩÔ∏è Best Selling Items",
            itemCosts: "üí∞ Costs by Item",
            itemMargins: "üìà Profit Margin by Item",
            // Chart labels
            costs: "Costs",
            profits: "Profits",
            profitMarginLabel: "Profit Margin (%)",
            totalCostsLabel: "Total Costs",
            profitMarginPercent: "Profit Margin (%)",
            dailySalesLabel: "Daily Sales ($)",
            dailyOrdersLabel: "Daily Orders",
            hourlyOrdersLabel: "Orders by Hour"
            ,
            autoRefresh: "üîÅ Auto-refresh",
            refreshNow: "‚ü≥ Refresh Now"
        });

        const REFRESH_INTERVAL = 60000; // milliseconds (default 60s)
        let refreshTimerId = null;
        let refreshActive = false;
        let isLoadingAnalytics = false;

        async function autoRefreshTick() {
            if (!refreshActive) return;
            // Skip if page is not visible or user interacting with date inputs
            if (document.hidden) {
                // page not visible, postpone
                refreshTimerId = setTimeout(autoRefreshTick, REFRESH_INTERVAL);
                return;
            }
            // Skip if user interacting with date inputs
            const startFocused = document.activeElement && document.activeElement.id === 'startDate';
            const endFocused = document.activeElement && document.activeElement.id === 'endDate';
            if (startFocused || endFocused) {
                // schedule next tick
                refreshTimerId = setTimeout(autoRefreshTick, REFRESH_INTERVAL);
                return;
            }

            if (isLoadingAnalytics) {
                // Previous tick still running; avoid overlap
                console.debug('autoRefreshTick: previous load still running, skipping this tick');
                refreshTimerId = setTimeout(autoRefreshTick, REFRESH_INTERVAL);
                return;
            }

            try {
                isLoadingAnalytics = true;
                await loadAnalytics();
            } catch (e) {
                console.error('autoRefreshTick loadAnalytics error', e);
            } finally {
                isLoadingAnalytics = false;
                // schedule next tick
                refreshTimerId = setTimeout(autoRefreshTick, REFRESH_INTERVAL);
            }
        }

        function startAutoRefresh() {
            if (refreshActive) return;
            // Do not start auto-refresh while using dummy data
            const useDummyEl = document.getElementById && document.getElementById('useDummyData');
            if (useDummyEl && useDummyEl.checked) {
                console.debug('startAutoRefresh: dummy mode active, not starting');
                return;
            }
            refreshActive = true;
            console.debug('startAutoRefresh');
            // schedule first tick after interval to avoid immediate duplicate load
            refreshTimerId = setTimeout(autoRefreshTick, REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (!refreshActive) return;
            refreshActive = false;
            console.debug('stopAutoRefresh');
            if (refreshTimerId) {
                clearTimeout(refreshTimerId);
                refreshTimerId = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAnalytics();

            // Restore auto-refresh preference (default OFF)
            const storedAuto = localStorage.getItem('analytics.autoRefresh') === 'true';
            const autoEl = document.getElementById('autoRefreshToggle');
            if (autoEl) {
                autoEl.checked = storedAuto;
                autoEl.addEventListener('change', (e) => {
                    const enabled = !!e.target.checked;
                    localStorage.setItem('analytics.autoRefresh', enabled ? 'true' : 'false');
                    if (enabled) startAutoRefresh(); else stopAutoRefresh();
                });
            }

            // Start auto-refresh only if user enabled it
            if (storedAuto) startAutoRefresh();

            // Add event listeners for buttons and checkbox
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            document.getElementById('useDummyData').addEventListener('change', toggleDummyData);
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) refreshBtn.addEventListener('click', () => { loadAnalytics(); });
            enableDatePickers();

            // Pause auto-refresh while interacting with date inputs
            const start = document.getElementById('startDate');
            const end = document.getElementById('endDate');
            if (start && end) {
                ['focus', 'mousedown', 'touchstart'].forEach(evt => {
                    const opts = evt === 'touchstart' ? { passive: true } : false;
                    start.addEventListener(evt, stopAutoRefresh, opts);
                    end.addEventListener(evt, stopAutoRefresh, opts);
                });
                ['blur', 'mouseup', 'touchend'].forEach(evt => {
                    const opts = evt === 'touchend' ? { passive: true } : false;
                    start.addEventListener(evt, () => { setTimeout(startAutoRefresh, 500); }, opts);
                    end.addEventListener(evt, () => { setTimeout(startAutoRefresh, 500); }, opts);
                });
            }
        });

        function enableDatePickers() {
            const start = document.getElementById('startDate');
            const end = document.getElementById('endDate');
            if (!start || !end) return;

            const openPicker = (el) => {
                try {
                    if (typeof el.showPicker === 'function') {
                        el.showPicker();
                    } else {
                        el.focus();
                    }
                } catch (e) {
                    // Some browsers may throw when calling showPicker; fallback to focus
                    el.focus();
                }
            };

            // If labels have for=, clicking them will focus; also explicitly open picker when label clicked
            const startLabel = document.querySelector('label[for="startDate"]');
            const endLabel = document.querySelector('label[for="endDate"]');
            if (startLabel) startLabel.addEventListener('click', (e) => { e.preventDefault(); openPicker(start); });
            if (endLabel) endLabel.addEventListener('click', (e) => { e.preventDefault(); openPicker(end); });

            // Also open picker when input itself is clicked (helps when focus doesn't show UI)
            start.addEventListener('click', () => openPicker(start));
            end.addEventListener('click', () => openPicker(end));
        }

        let lastAnalyticsLoadTs = 0;
        async function loadAnalytics() {
            // If user opted to use dummy data, do not fetch from server
            const useDummyEl = document.getElementById && document.getElementById('useDummyData');
            if (useDummyEl && useDummyEl.checked) {
                console.debug('loadAnalytics: dummy mode active, skipping fetch');
                return;
            }

            const now = Date.now();
            // Throttle rapid duplicate calls (extensions or multiple timers may fire)
            if (now - lastAnalyticsLoadTs < 1200) {
                console.debug('loadAnalytics: skipping duplicate call (throttle)');
                return;
            }
            lastAnalyticsLoadTs = now;

            if (isLoadingAnalytics) {
                console.debug('loadAnalytics: previous load in progress, skipping');
                return;
            }

            console.log('Loading analytics');
            console.trace('loadAnalytics trace');
            try {
                isLoadingAnalytics = true;
                    // include profit/cost configuration as query params
                    const cfg = {
                        monthly_rent: Number((document.getElementById('monthlyRent') && document.getElementById('monthlyRent').value) || localStorage.getItem('analytics.monthlyRent') || 0),
                        courier_cost: Number((document.getElementById('courierCost') && document.getElementById('courierCost').value) || localStorage.getItem('analytics.courierCost') || 0),
                        hourly_wage: Number((document.getElementById('hourlyWage') && document.getElementById('hourlyWage').value) || localStorage.getItem('analytics.hourlyWage') || 0),
                        daily_hours: Number((document.getElementById('dailyHours') && document.getElementById('dailyHours').value) || localStorage.getItem('analytics.dailyHours') || 0)
                    };
                    const params = new URLSearchParams(cfg);
                    const response = await fetch('/api/analytics?' + params.toString());
                console.log('Response status:', response.status);
                analyticsData = await response.json();

                updateStats();
                createCharts();

                // Set current date as default if not already set
                if (!document.getElementById('startDate').value) {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('startDate').value = today;
                    document.getElementById('endDate').value = today;
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            } finally {
                isLoadingAnalytics = false;
            }
        }

        // Profit config helpers
        function loadProfitConfigToUI() {
            const monthly = localStorage.getItem('analytics.monthlyRent');
            const courier = localStorage.getItem('analytics.courierCost');
            const hourly = localStorage.getItem('analytics.hourlyWage');
            const hours = localStorage.getItem('analytics.dailyHours');
            if (monthly && document.getElementById('monthlyRent')) document.getElementById('monthlyRent').value = monthly;
            if (courier && document.getElementById('courierCost')) document.getElementById('courierCost').value = courier;
            if (hourly && document.getElementById('hourlyWage')) document.getElementById('hourlyWage').value = hourly;
            if (hours && document.getElementById('dailyHours')) document.getElementById('dailyHours').value = hours;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadProfitConfigToUI();
            const applyBtn = document.getElementById('applyProfitConfigBtn');
            if (applyBtn) applyBtn.addEventListener('click', () => {
                const m = document.getElementById('monthlyRent').value || 0;
                const c = document.getElementById('courierCost').value || 0;
                const h = document.getElementById('hourlyWage').value || 0;
                const d = document.getElementById('dailyHours').value || 0;
                localStorage.setItem('analytics.monthlyRent', m);
                localStorage.setItem('analytics.courierCost', c);
                localStorage.setItem('analytics.hourlyWage', h);
                localStorage.setItem('analytics.dailyHours', d);
                loadAnalytics();
            });
            // Live update when config inputs change (save and refresh charts)
            ['monthlyRent','courierCost','hourlyWage','dailyHours'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('change', () => {
                    const m = document.getElementById('monthlyRent').value || 0;
                    const c = document.getElementById('courierCost').value || 0;
                    const h = document.getElementById('hourlyWage').value || 0;
                    const d = document.getElementById('dailyHours').value || 0;
                    localStorage.setItem('analytics.monthlyRent', m);
                    localStorage.setItem('analytics.courierCost', c);
                    localStorage.setItem('analytics.hourlyWage', h);
                    localStorage.setItem('analytics.dailyHours', d);
                    // If using dummy data, regenerate locally; otherwise fetch from server
                    const useDummy = document.getElementById('useDummyData') && document.getElementById('useDummyData').checked;
                    if (useDummy) {
                        analyticsData = generateDummyData();
                        updateStats();
                        createCharts();
                    } else {
                        loadAnalytics();
                    }
                });
            });

            // Product COGS modal wiring
            const editBtn = document.getElementById('editProductCogsBtn');
            if (editBtn) editBtn.addEventListener('click', async () => { openProductCogsModal(); });
            const closePCBtn = document.getElementById('closeProductCogsBtn');
            if (closePCBtn) closePCBtn.addEventListener('click', () => { closeProductCogsModal(); });
            const savePCBtn = document.getElementById('saveProductCogsBtn');
            if (savePCBtn) savePCBtn.addEventListener('click', () => { saveProductCogs(); });
        });

        function toggleDummyData() {
            console.debug('toggleDummyData called', new Date().toISOString());
            const useDummy = document.getElementById('useDummyData').checked;
            if (useDummy) {
                // Use generated dummy data directly ‚Äî do not trigger fetch
                analyticsData = generateDummyData();
                updateStats();
                createCharts();
                // Stop auto-refresh while in dummy mode
                stopAutoRefresh();
            } else {
                // Switch back to live data ‚Äî resume auto-refresh if user preference enabled
                const storedAuto = localStorage.getItem('analytics.autoRefresh') === 'true';
                if (storedAuto) startAutoRefresh();
                loadAnalytics();
            }
        }

        async function openProductCogsModal() {
            const modal = document.getElementById('productCogsModal');
            const content = document.getElementById('productCogsContent');
            content.innerHTML = '<div style="grid-column:1/-1;color:var(--fg-muted);">Loading...</div>';
            modal.style.display = 'flex';
            try {
                const menuResp = await fetch('/api/menu');
                const menu = await menuResp.json();
                const costsResp = await fetch('/api/product_costs');
                const costs = await costsResp.json();
                const flat = [];
                Object.values(menu).forEach(category => {
                    Object.keys(category).forEach(name => flat.push(name));
                });
                // build inputs
                content.innerHTML = '';
                flat.forEach(name => {
                    const row = document.createElement('div');
                    row.style.display = 'contents';
                    const label = document.createElement('div');
                    label.textContent = name;
                    label.style.padding = '0.35rem 0.5rem';
                    label.style.color = 'var(--fg)';
                    const inputWrap = document.createElement('div');
                    inputWrap.style.padding = '0.25rem';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.min = '0';
                    input.style.width = '100%';
                    input.value = costs && costs[name] ? costs[name] : '';
                    input.setAttribute('data-prod-name', name);
                    inputWrap.appendChild(input);
                    content.appendChild(label);
                    content.appendChild(inputWrap);
                });
            } catch (e) {
                content.innerHTML = '<div style="grid-column:1/-1;color:var(--danger);">Failed to load product list.</div>';
                console.error('openProductCogsModal error', e);
            }
        }

        function closeProductCogsModal() {
            const modal = document.getElementById('productCogsModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        async function saveProductCogs() {
            const content = document.getElementById('productCogsContent');
            if (!content) return;
            const inputs = content.querySelectorAll('input[data-prod-name]');
            const payload = {};
            inputs.forEach(inp => {
                const name = inp.getAttribute('data-prod-name');
                const val = inp.value;
                if (val !== '') payload[name] = Number(val);
            });
            try {
                const resp = await fetch('/api/product_costs', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await resp.json();
                if (data && data.ok) {
                    closeProductCogsModal();
                    // reload analytics now to reflect new costs
                    const useDummy = document.getElementById('useDummyData') && document.getElementById('useDummyData').checked;
                    if (useDummy) { analyticsData = generateDummyData(); updateStats(); createCharts(); }
                    else { loadAnalytics(); }
                } else {
                    alert('Failed to save product costs');
                }
            } catch (e) {
                console.error('saveProductCogs error', e);
                alert('Failed to save product costs');
            }
        }

        // Detect real page unloads (navigations / hard reloads)
        window.addEventListener('beforeunload', (e) => {
            console.warn('Page beforeunload fired', e);
        });

        function generateDummyData() {
            const today = new Date();
            const dummyData = {
                total_orders: 312,
                total_revenue: 18750,
                avg_order_value: 60.1,
                total_costs: 11250,
                total_profits: 7500,
                profit_margin: 40.0,
                avg_profit_per_order: 24.0,
                daily_sales: [],
                daily_orders: [],
                daily_costs: [],
                daily_profits: [],
                daily_breakdowns: [],
                hourly_orders: [],
                popular_items: [],
                item_costs: [],
                item_margins: []
            };

            // Menu items used for dummy generation
            const menuItems = [
                "Pollo con Papas", "Milanesa con Ensalada", "Hamburguesa Completa",
                "Pizza Individual", "Empanadas (6)", "Asado para 2", "Sushi Rolls",
                "Pasta Alfredo", "Ensalada C√©sar", "Tacos Mexicanos"
            ];

            // Generate data for the last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                // Random but realistic daily data
                const dailyOrders = Math.floor(Math.random() * 15) + 5; // 5-20 orders per day
                const avgOrderValue = 55 + Math.random() * 15; // $55-70 per order
                const dailyRevenue = dailyOrders * avgOrderValue;
                const dailyCosts = dailyRevenue * (0.55 + Math.random() * 0.15); // 55-70% cost
                const dailyProfits = dailyRevenue - dailyCosts;
                
                dummyData.daily_sales.push([dateStr, Math.round(dailyRevenue)]);
                dummyData.daily_orders.push([dateStr, dailyOrders]);
                dummyData.daily_costs.push([dateStr, Math.round(dailyCosts)]);
                dummyData.daily_profits.push([dateStr, Math.round(dailyProfits)]);
                // Build a reasonable breakdown for dummy data so the breakdown modal can display details
                // Use configured profit values from localStorage so dummy mode reflects user inputs
                const cfgMonthly = Number(localStorage.getItem('analytics.monthlyRent') || 0);
                const cfgCourier = Number(localStorage.getItem('analytics.courierCost') || 0);
                const cfgHourly = Number(localStorage.getItem('analytics.hourlyWage') || 0);
                const cfgDailyHours = Number(localStorage.getItem('analytics.dailyHours') || 0);
                const rentPerDay = Math.round(cfgMonthly / 30);
                const laborPerDay = Math.round(cfgHourly * cfgDailyHours);
                const courierTotal = Math.round(dailyOrders * cfgCourier);
                let productCogs = Math.round(dailyCosts - (rentPerDay + laborPerDay + courierTotal));
                if (productCogs < 0) productCogs = Math.max(0, Math.round(dailyCosts * 0.6));
                // generate per-day products sold breakdown (random distribution) and courier counts
                const productsSold = {};
                let rem = dailyOrders;
                const dayMenu = menuItems || [
                    "Pollo con Papas", "Milanesa con Ensalada", "Hamburguesa Completa",
                    "Pizza Individual", "Empanadas (6)", "Asado para 2", "Sushi Rolls",
                    "Pasta Alfredo", "Ensalada C√©sar", "Tacos Mexicanos"
                ];
                while (rem > 0) {
                    const pick = dayMenu[Math.floor(Math.random() * dayMenu.length)];
                    productsSold[pick] = (productsSold[pick] || 0) + 1;
                    rem--;
                }
                // couriers distribution (3 drivers)
                const courierDrivers = ['Driver A','Driver B','Driver C'];
                const courierCounts = {};
                let rem2 = dailyOrders;
                while (rem2 > 0) {
                    const pick = courierDrivers[Math.floor(Math.random() * courierDrivers.length)];
                    courierCounts[pick] = (courierCounts[pick] || 0) + 1;
                    rem2--;
                }

                dummyData.daily_breakdowns.push([dateStr, {
                    revenue: Math.round(dailyRevenue),
                    product_cogs: productCogs,
                    rent: rentPerDay,
                    labor: laborPerDay,
                    courier: courierTotal,
                    total_cost: Math.round(dailyCosts),
                    profit: Math.round(dailyProfits),
                    orders: dailyOrders,
                    products: Object.entries(productsSold).sort((a,b)=>b[1]-a[1]),
                    couriers: Object.entries(courierCounts).sort((a,b)=>b[1]-a[1])
                }]);
            }

            // Generate hourly orders (24 hours)
            for (let hour = 0; hour < 24; hour++) {
                let ordersPerHour;
                if (hour >= 11 && hour <= 14) { // Lunch rush
                    ordersPerHour = Math.floor(Math.random() * 20) + 15; // 15-35 orders
                } else if (hour >= 18 && hour <= 21) { // Dinner rush
                    ordersPerHour = Math.floor(Math.random() * 25) + 20; // 20-45 orders
                } else if (hour >= 7 && hour <= 10) { // Morning
                    ordersPerHour = Math.floor(Math.random() * 8) + 2; // 2-10 orders
                } else {
                    ordersPerHour = Math.floor(Math.random() * 5) + 1; // 1-6 orders
                }
                dummyData.hourly_orders.push([hour, ordersPerHour]);
            }

            // Popular items (top 10 items)
            const popularMenuItems = [
                "Pollo con Papas", "Milanesa con Ensalada", "Hamburguesa Completa", 
                "Pizza Individual", "Empanadas (6)", "Asado para 2", "Sushi Rolls",
                "Pasta Alfredo", "Ensalada C√©sar", "Tacos Mexicanos"
            ];
            
            popularMenuItems.forEach((item, index) => {
                const orders = 312 - (index * 25) + Math.floor(Math.random() * 20); // Decreasing popularity
                dummyData.popular_items.push([item, orders]);
            });

            // Item costs and margins
            popularMenuItems.forEach((item, index) => {
                const itemPrice = 45 + (index * 5) + Math.random() * 20; // $45-140
                const itemCost = itemPrice * (0.4 + Math.random() * 0.3); // 40-70% cost
                const totalCost = itemCost * dummyData.popular_items[index][1];
                const margin = ((itemPrice - itemCost) / itemPrice) * 100;
                
                dummyData.item_costs.push([item, Math.round(totalCost)]);
                dummyData.item_margins.push([item, Math.round(margin * 10) / 10]); // 1 decimal
            });

            return dummyData;
        }

        function updateStats() {
            document.getElementById('totalOrders').textContent = analyticsData.total_orders;
            document.getElementById('totalRevenue').textContent = `$${analyticsData.total_revenue.toLocaleString()}`;
            document.getElementById('avgOrderValue').textContent = `$${analyticsData.avg_order_value.toLocaleString()}`;
            document.getElementById('totalCosts').textContent = `$${analyticsData.total_costs.toLocaleString()}`;
            document.getElementById('totalProfits').textContent = `$${analyticsData.total_profits.toLocaleString()}`;
            document.getElementById('profitMargin').textContent = `${analyticsData.profit_margin}%`;
            document.getElementById('avgProfitPerOrder').textContent = `$${analyticsData.avg_profit_per_order.toLocaleString()}`;

            // Calculate today's orders
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = analyticsData.daily_orders.find(([date]) => date === today);
            document.getElementById('todayOrders').textContent = todayOrders ? todayOrders[1] : 0;
        }

        function createCharts() {
            try {
            // Daily Sales Chart
            const dailySalesCtx = getFreshCtx('dailySalesChart');
            if (chartInstances['dailySalesChart']) { try { chartInstances['dailySalesChart'].destroy(); } catch(e){ console.debug('destroy dailySalesChart error', e); } }
            try {
                chartInstances['dailySalesChart'] = new Chart(dailySalesCtx, {
                type: 'line',
                data: {
                    labels: analyticsData.daily_sales.map(([date]) => formatDate(date)),
                    datasets: [{
                        label: translations[currentLang].dailySalesLabel,
                        data: analyticsData.daily_sales.map(([, sales]) => sales),
                        borderColor: 'var(--success)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => `$${value.toLocaleString()}`
                            }
                        }
                    }
                }
                });
            } catch (err) { console.error('Failed to create dailySalesChart', err); }

            // Daily Orders Chart
            const dailyOrdersCtx = getFreshCtx('dailyOrdersChart');
            if (chartInstances['dailyOrdersChart']) { try { chartInstances['dailyOrdersChart'].destroy(); } catch(e){ console.debug('destroy dailyOrdersChart error', e); } }
            try {
                chartInstances['dailyOrdersChart'] = new Chart(dailyOrdersCtx, {
                type: 'bar',
                data: {
                    labels: analyticsData.daily_orders.map(([date]) => formatDate(date)),
                    datasets: [{
                        label: translations[currentLang].dailyOrdersLabel,
                        data: analyticsData.daily_orders.map(([, count]) => count),
                        backgroundColor: 'rgba(14,99,156,0.85)',
                        borderColor: 'rgba(14,99,156,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
                });
            } catch (err) { console.error('Failed to create dailyOrdersChart', err); }

            // Hourly Orders Chart (fixed hourly axis 06:00 - 24:00, 1-hour granularity)
            const hourlyOrdersCtx = getFreshCtx('hourlyOrdersChart');
            if (chartInstances['hourlyOrdersChart']) { try { chartInstances['hourlyOrdersChart'].destroy(); } catch(e){ console.debug('destroy hourlyOrdersChart error', e); } }
            try {
                // Build labels 06:00 .. 24:00
                const hourLabels = [];
                for (let h = 6; h <= 24; h++) {
                    hourLabels.push((h < 10 ? '0' + h : h) + ':00');
                }

                // Map incoming hourly data (array of [hour, count]) to a lookup
                const hourMap = {};
                (analyticsData.hourly_orders || []).forEach(([hour, count]) => { hourMap[hour] = count; });

                // Build counts array matching labels; treat 24:00 as hour 0 (midnight) if present
                const hourCounts = [];
                for (let h = 6; h <= 24; h++) {
                    if (h === 24) {
                        hourCounts.push(hourMap[0] || 0);
                    } else {
                        hourCounts.push(hourMap[h] || 0);
                    }
                }

                chartInstances['hourlyOrdersChart'] = new Chart(hourlyOrdersCtx, {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: translations[currentLang].hourlyOrdersLabel,
                        data: hourCounts,
                        backgroundColor: 'rgba(255,152,0,0.9)',
                        borderColor: 'rgba(255,152,0,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            // show every hour label
                            ticks: { autoSkip: false }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
                });
            } catch (err) { console.error('Failed to create hourlyOrdersChart', err); }

            // Popular Items Chart
            const popularItemsCtx = getFreshCtx('popularItemsChart');
            if (chartInstances['popularItemsChart']) { try { chartInstances['popularItemsChart'].destroy(); } catch(e){ console.debug('destroy popularItemsChart error', e); } }
            try {
                chartInstances['popularItemsChart'] = new Chart(popularItemsCtx, {
                type: 'doughnut',
                data: {
                    labels: analyticsData.popular_items.map(([item]) => item.length > 20 ? item.substring(0, 20) + '...' : item),
                    datasets: [{
                        data: analyticsData.popular_items.map(([, count]) => count),
                        backgroundColor: [
                            'var(--accent)', 'var(--success)', 'var(--warning)', 'var(--danger)',
                            '#5e35b1', '#26a69a', '#ab47bc', '#8d6e63',
                            '#78909c', '#7cb342'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: { size: 11 }
                            }
                        }
                    }
                }
                });
            } catch (err) { console.error('Failed to create popularItemsChart', err); }

            // Daily Costs vs Profits Chart
            const dailyCostsProfitsCtx = getFreshCtx('dailyCostsProfitsChart');
            if (chartInstances['dailyCostsProfitsChart']) { try { chartInstances['dailyCostsProfitsChart'].destroy(); } catch(e){ console.debug('destroy dailyCostsProfitsChart error', e); } }
            try {
                chartInstances['dailyCostsProfitsChart'] = new Chart(dailyCostsProfitsCtx, {
                type: 'bar',
                data: {
                    labels: analyticsData.daily_costs.map(([date]) => formatDate(date)),
                    datasets: [{
                        label: translations[currentLang].costs,
                        data: analyticsData.daily_costs.map(([, cost]) => cost),
                        backgroundColor: 'rgba(244,67,54,0.85)',
                        borderColor: 'rgba(244,67,54,1)',
                        borderWidth: 1
                    }, {
                        label: translations[currentLang].profits,
                        data: analyticsData.daily_profits.map(([, profit]) => profit),
                        backgroundColor: 'rgba(76,175,80,0.85)',
                        borderColor: 'rgba(76,175,80,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    onClick: function(evt, elements) {
                        if (!elements || elements.length === 0) return;
                        const el = elements[0];
                        const idx = el.index;
                        const date = analyticsData.daily_costs[idx][0];
                        const breakdownArr = analyticsData.daily_breakdowns || [];
                        let breakdown = null;
                        for (const [d, b] of breakdownArr) {
                            if (d === date) { breakdown = b; break; }
                        }
                        if (breakdown) showBreakdownModal(date, breakdown);
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => `$${value.toLocaleString()}`
                            }
                        }
                    }
                }
                });
            } catch (err) { console.error('Failed to create dailyCostsProfitsChart', err); }

            // Show breakdown modal for a date
            function showBreakdownModal(date, breakdown) {
                const modal = document.getElementById('chartModal');
                const titleEl = document.getElementById('modalChartTitle');
                const holder = document.getElementById('modalCanvasHolder');
                titleEl.textContent = 'Breakdown for ' + formatDate(date);
                // layout: left = summary, middle = products, right = couriers
                const productsHtml = (breakdown.products || []).map(([name,qty]) => `<li style="padding:0.15rem 0;display:flex;justify-content:space-between;align-items:center;">${escapeHtml(name)}<span style=\"margin-left:1rem;font-weight:600;color:var(--fg)\">${qty}</span></li>`).join('') || '<li style="color:var(--fg-muted)">No products</li>';
                const couriersHtml = (breakdown.couriers || []).map(([name,qty]) => `<li style="padding:0.15rem 0;display:flex;justify-content:space-between;align-items:center;">${escapeHtml(name)}<span style=\"margin-left:1rem;font-weight:600;color:var(--fg)\">${qty}</span></li>`).join('') || '<li style="color:var(--fg-muted)">No couriers</li>';
                holder.innerHTML = `
                    <div style="display:grid;grid-template-columns:1.4fr 1.8fr 0.8fr;gap:1rem;padding:0.5rem;color:var(--fg);align-items:start;">
                        <div style="padding-right:0.75rem;">
                            <div><strong>Orders:</strong> ${breakdown.orders}</div>
                            <div><strong>Total Revenue:</strong> $${Number(breakdown.revenue || 0).toLocaleString()}</div>
                            <div><strong>Product COGS:</strong> $${Number(breakdown.product_cogs).toLocaleString()}</div>
                            <div><strong>Rent (per day):</strong> $${Number(breakdown.rent).toLocaleString()}</div>
                            <div><strong>Labor (per day):</strong> $${Number(breakdown.labor).toLocaleString()}</div>
                            <div><strong>Courier (total):</strong> $${Number(breakdown.courier).toLocaleString()}</div>
                            <div style="margin-top:0.5rem;"><strong>Total Costs:</strong> $${Number(breakdown.total_cost).toLocaleString()}</div>
                            <div style="margin-top:0.5rem;color:${breakdown.profit<0?'#f44336':'#4caf50'};"><strong>Net Profit:</strong> $${Number(breakdown.profit).toLocaleString()}</div>
                        </div>
                        <div style="padding:0 1rem;border-left:1px solid var(--border);border-right:1px solid transparent;">
                            <h4 style="margin:0 0 0.5rem 0;color:var(--fg);text-align:center;">Products Sold</h4>
                            <ul style="list-style:none;padding:0.15rem 0.5rem;margin:0;max-height:380px;overflow:auto;color:var(--fg);">${productsHtml}</ul>
                        </div>
                        <div style="padding-left:1rem;border-left:1px solid var(--border);">
                            <h4 style="margin:0 0 0.5rem 0;color:var(--fg);text-align:center;">Couriers</h4>
                            <ul style="list-style:none;padding:0;margin:0;max-height:380px;overflow:auto;color:var(--fg);">${couriersHtml}</ul>
                        </div>
                    </div>
                `;
                // ensure modalOpenChartId is cleared so closeChartModal won't attempt to restore a canvas
                modalOpenChartId = null;
                modal.style.display = 'flex';
            }

            // (Removed legacy per-item and profit-margin charts)
            } catch (err) {
                console.error('Error in createCharts:', err);
            }

            // Keep legacy globals in sync for existing code (filters/reset rely on these)
            dailySalesChart = chartInstances['dailySalesChart'] || null;
            dailyOrdersChart = chartInstances['dailyOrdersChart'] || null;
            hourlyOrdersChart = chartInstances['hourlyOrdersChart'] || null;
            popularItemsChart = chartInstances['popularItemsChart'] || null;
            dailyCostsProfitsChart = chartInstances['dailyCostsProfitsChart'] || null;
        }

        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}`;
        }

        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Por favor selecciona ambas fechas');
                return;
            }

            // Filter data based on date range
            const filteredSales = analyticsData.daily_sales.filter(([date]) =>
                date >= startDate && date <= endDate
            );
            const filteredOrders = analyticsData.daily_orders.filter(([date]) =>
                date >= startDate && date <= endDate
            );
            const filteredCosts = analyticsData.daily_costs.filter(([date]) =>
                date >= startDate && date <= endDate
            );
            const filteredProfits = analyticsData.daily_profits.filter(([date]) =>
                date >= startDate && date <= endDate
            );

            // Update charts with filtered data
            dailySalesChart.data.labels = filteredSales.map(([date]) => formatDate(date));
            dailySalesChart.data.datasets[0].data = filteredSales.map(([, sales]) => sales);
            dailySalesChart.update();

            dailyOrdersChart.data.labels = filteredOrders.map(([date]) => formatDate(date));
            dailyOrdersChart.data.datasets[0].data = filteredOrders.map(([, count]) => count);
            dailyOrdersChart.update();

            dailyCostsProfitsChart.data.labels = filteredCosts.map(([date]) => formatDate(date));
            dailyCostsProfitsChart.data.datasets[0].data = filteredCosts.map(([, cost]) => cost);
            dailyCostsProfitsChart.data.datasets[1].data = filteredProfits.map(([, profit]) => profit);
            dailyCostsProfitsChart.update();

            // (profit margin chart removed)
        }

        // Modal logic: clone canvas into modal to avoid moving original canvas (prevents disappearance on updates)
        let modalOpenChartId = null;
        function openChartModal(chartId, title) {
            if (modalOpenChartId) return;
            const chart = chartInstances[chartId];
            if (!chart) return;

            const holder = document.getElementById('modalCanvasHolder');
            const modal = document.getElementById('chartModal');
            const titleEl = document.getElementById('modalChartTitle');
            titleEl.textContent = title || '';

            // create a cloned canvas for the modal so the original chart remains in-place
            const modalCanvas = document.createElement('canvas');
            const cloneId = chartId + '_modal_clone';
            modalCanvas.id = cloneId;
            // style rules to make it behave like canvas inside modal
            modalCanvas.style.width = '100%';
            modalCanvas.style.height = '100%';
            holder.appendChild(modalCanvas);

            // create a snapshot of the chart data/options (shallow copy where appropriate)
            let cloneConfig = null;
            try {
                cloneConfig = {
                    type: chart.config.type,
                    data: JSON.parse(JSON.stringify(chart.data)),
                    options: JSON.parse(JSON.stringify(chart.options || {}))
                };
            } catch (e) {
                // fallback: reuse config if deep copy fails
                cloneConfig = { type: chart.config.type, data: chart.data, options: chart.options };
            }
            // Preserve function handlers (like onClick) which are lost by JSON serialization
            try {
                if (chart && chart.config && chart.config.options) {
                    cloneConfig.options = cloneConfig.options || {};
                    if (typeof chart.config.options.onClick === 'function') {
                        cloneConfig.options.onClick = chart.config.options.onClick;
                    }
                    // copy plugin callbacks if present
                    if (chart.config.options.plugins) {
                        cloneConfig.options.plugins = cloneConfig.options.plugins || {};
                        Object.keys(chart.config.options.plugins).forEach(k => {
                            const val = chart.config.options.plugins[k];
                            if (val && typeof val === 'object') {
                                // shallow copy functions inside plugin config
                                cloneConfig.options.plugins[k] = cloneConfig.options.plugins[k] || {};
                                Object.keys(val).forEach(pk => {
                                    if (typeof val[pk] === 'function') cloneConfig.options.plugins[k][pk] = val[pk];
                                });
                            }
                        });
                    }
                }
            } catch (e) {
                console.debug('Could not preserve function handlers for clone', e);
            }

            try {
                const ctx = modalCanvas.getContext('2d');
                chartInstances[cloneId] = new Chart(ctx, cloneConfig);
                modal.style.display = 'flex';
                modalOpenChartId = cloneId;
            } catch (e) {
                console.error('Failed to create modal chart clone', e);
            }
        }

        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            if (!modalOpenChartId) { modal.style.display = 'none'; return; }

            const cloneId = modalOpenChartId;
            const cloneCanvas = document.getElementById(cloneId);
            const cloneChart = chartInstances[cloneId];
            try {
                if (cloneChart) { try { cloneChart.destroy(); } catch(e){ } }
            } catch (e) { console.debug('error destroying clone chart', e); }
            if (cloneCanvas && cloneCanvas.parentNode) cloneCanvas.parentNode.removeChild(cloneCanvas);
            delete chartInstances[cloneId];
            modal.style.display = 'none';
            modalOpenChartId = null;
        }

        // Wire modal close button
        document.addEventListener('DOMContentLoaded', () => {
            const closeBtn = document.getElementById('closeChartModal');
            if (closeBtn) closeBtn.addEventListener('click', closeChartModal);

            // Clicking outside content closes modal
            const modal = document.getElementById('chartModal');
            if (modal) modal.addEventListener('click', (e) => {
                if (e.target === modal) closeChartModal();
            });

            // Add click handlers to chart containers to open modal
            ['dailySalesChart','dailyOrdersChart','dailyCostsProfitsChart','hourlyOrdersChart','popularItemsChart'].forEach(id => {
                const canvas = document.getElementById(id);
                if (!canvas) return;
                const container = canvas.closest('.chart-container');
                if (!container) return;
                container.style.cursor = 'zoom-in';
                container.addEventListener('click', (e) => {
                    // If the chart has elements at the click position, let the chart's own onClick handler deal with it
                    const chart = chartInstances[id];
                    try {
                        if (chart && typeof chart.getElementsAtEventForMode === 'function') {
                            const elems = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                            if (elems && elems.length > 0) {
                                // Chart handled click (e.g., bar/point) ‚Äî do not open zoom modal
                                return;
                            }
                        }
                    } catch (err) {
                        console.debug('chart interaction check failed', err);
                    }
                    // No chart element interacted ‚Äî open zoom modal
                    openChartModal(id, document.querySelector('[data-translate]') ? '' : '');
                });
            });
        });

        function resetFilters() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;

            // Reset to full data
            dailySalesChart.data.labels = analyticsData.daily_sales.map(([date]) => formatDate(date));
            dailySalesChart.data.datasets[0].data = analyticsData.daily_sales.map(([, sales]) => sales);
            dailySalesChart.update();

            dailyOrdersChart.data.labels = analyticsData.daily_orders.map(([date]) => formatDate(date));
            dailyOrdersChart.data.datasets[0].data = analyticsData.daily_orders.map(([, count]) => count);
            dailyOrdersChart.update();

            dailyCostsProfitsChart.data.labels = analyticsData.daily_costs.map(([date]) => formatDate(date));
            dailyCostsProfitsChart.data.datasets[0].data = analyticsData.daily_costs.map(([, cost]) => cost);
            dailyCostsProfitsChart.data.datasets[1].data = analyticsData.daily_profits.map(([, profit]) => profit);
            dailyCostsProfitsChart.update();

            // (profit margin chart removed)
        }

        function toggleLanguage() {
            currentLang = currentLang === 'es' ? 'en' : 'es';
            localStorage.setItem('lang', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            document.getElementById('langBtn').textContent = translations[currentLang].langBtn;
            // Update navigation
            document.querySelector('a[href="/"]').textContent = translations[currentLang].menu;
            document.querySelector('a[href="/pedidos"]').textContent = translations[currentLang].pedidos;
            document.querySelector('a[href="/analytics"]').textContent = translations[currentLang].analytics;
            document.querySelector('a[href="/drivers"]').textContent = translations[currentLang].drivers;
            document.querySelector('a[href="/deliveries"]').textContent = translations[currentLang].deliveries;
            // Update title
            document.querySelector('h1').textContent = translations[currentLang].title;
            
            // Update elements with data-translate attributes
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLang][key]) {
                    element.textContent = translations[currentLang][key];
                }
            });
            
            // Recreate charts if data is loaded
            if (analyticsData) {
                createCharts();
            }
        }

        // Apply on load
        applyLanguage();
    </script>
</body>
</html>
