<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pedidos - Rotiser√≠a</title>
    {% include '_header_css.html' %}
    <style>
        :root{--bg:#1e1e1e;--card:#2d2d2d;--fg:#e0e0e0;--muted:#a0a0a0;--accent:#0e639c;--success:#4caf50;--border:#444}
        *{box-sizing:border-box}
        body{font-family:Segoe UI,system-ui,Arial;min-height:100vh;background:var(--bg);color:var(--fg);margin:0}
        header{background:var(--card);padding:12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
        .nav{display:flex;gap:8px;align-items:center}
        .nav a{color:var(--fg);background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:6px;text-decoration:none}
        main{padding:16px;max-width:1000px;margin:0 auto}
        .orders{display:flex;flex-direction:column;gap:12px}
        .order-card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:8px}
        .order-header{display:flex;justify-content:space-between;align-items:center}
        .order-code{font-weight:700}
        .order-customer{color:var(--muted);font-size:0.95rem}
        .order-body{margin-top:8px}
        .order-item{display:flex;justify-content:space-between;padding:4px 0}
        .item-qty{font-weight:600;margin-right:6px}
        .order-total{margin-top:8px;color:var(--muted)}
        .order-actions{margin-top:8px}
        .btn-primary{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
        .btn-secondary{background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:6px;color:var(--fg);text-decoration:none}
        .empty-state{text-align:center;padding:3rem;color:var(--muted)}
        .toast{position:fixed;bottom:1.5rem;right:1.5rem;padding:.75rem 1.25rem;background:var(--success);color:#fff;border-radius:6px;transform:translateY(100px);opacity:0;transition:all .25s}
        .toast.show{transform:translateY(0);opacity:1}
    </style>
</head>
<body>
    {% include '_header.html' %}

    <main>
        <div id="ordersContainer" class="orders"></div>
        <div id="empty" class="empty-state" style="display:none">Esperando pedidos...</div>
    </main>

    <div id="toast" class="toast" style="display:none"></div>

    <script>
        // Pedidos page script (single, clean implementation)
        const ordersContainer = document.getElementById('ordersContainer');
        const emptyNode = document.getElementById('empty');
        const toast = document.getElementById('toast');
        let lastOrderCount = 0;

        async function safeFetch(path, opts){
            try{const r = await fetch(path, opts); if(!r.ok) return null; return await r.json()}catch(e){return null}
        }

        function showToast(msg){ toast.textContent = msg; toast.style.display = 'block'; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(()=>toast.style.display='none',300) },1800) }

        function escapeHtml(text){ if(text==null) return ''; const d=document.createElement('div'); d.textContent = text; return d.innerHTML }

        function renderOrders(orders){
            if(!Array.isArray(orders) || orders.length===0){ ordersContainer.innerHTML=''; emptyNode.style.display='block'; return }
            emptyNode.style.display='none';
            const sorted = [...orders].reverse();
            ordersContainer.innerHTML = sorted.map((order,i)=>{
                const time = (order.timestamp||'').split(' ')[1]||'';
                const status = order.status || 'pending';
                const orderId = order.id ?? i;
                const orderCode = order.code || `P${String(orderId).padStart(3,'0')}`;
                const itemsHtml = Object.entries(order.items||{}).map(([name,d])=>`<div class="order-item"><span><span class="item-qty">${(d.quantity||d)||0}x</span>${escapeHtml(name)}</span><span>$${((d.price||0)).toLocaleString()}</span></div>`).join('');
                const actionBtn = status==='pending' ? `<button class="btn-primary" onclick="updateStatus(${orderId},'finished')">‚úî Finalizar</button>` : '';
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-code">${orderCode}</div>
                                <div class="order-customer">${escapeHtml(order.customer)}</div>
                            </div>
                            <div class="order-time">${time}</div>
                        </div>
                        <div class="order-body">
                            ${itemsHtml}
                            ${order.notes?`<div class="order-notes">üìù ${escapeHtml(order.notes)}</div>`:''}
                            <div class="order-total">Total: $${(order.total||0).toLocaleString()}</div>
                            <div class="order-actions">${actionBtn}</div>
                        </div>
                    </div>`
            }).join('')
        }

        async function loadOrders(){
            const orders = await safeFetch('/api/history');
            if(!orders){ console.error('Failed to load orders'); return }
            if(orders.length>lastOrderCount && lastOrderCount>0){ showToast('üÜï ¬°Nuevo pedido!') }
            lastOrderCount = orders.length;
            renderOrders(orders.filter(o=>!o.status || o.status==='pending'));
        }

        async function updateStatus(orderId,status){
            try{
                const res = await fetch(`/api/order/${orderId}/status`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status})});
                if(res.ok){ loadOrders(); showToast('üöö Pedido actualizado') }
            }catch(e){console.error(e)}
        }

        // init
        loadOrders(); setInterval(loadOrders,3000);
    </script>
</body>
</html>
