<header>
    <h1 data-i18n="title">ğŸ— Sistema de Pedidos - RotiserÃ­a</h1>
    <nav class="header-actions" role="navigation" aria-label="Main navigation">
        <a href="/" class="btn btn-secondary" data-i18n="menu">ğŸ›’ MenÃº</a>
        <a href="/pedidos" class="btn btn-secondary" data-i18n="pedidos">ğŸ“‹ Pedidos</a>
        <a href="/analytics" class="btn btn-secondary" data-i18n="analytics">ğŸ“Š AnÃ¡lisis</a>
        <a href="/drivers" class="btn btn-secondary" data-i18n="drivers">ğŸ›µ Repartidores</a>
        <a href="/deliveries" class="btn btn-secondary" data-i18n="deliveries">ğŸšš Entregas</a>
        <button class="btn btn-secondary" onclick="toggleLanguage()" id="langBtn" data-i18n="langBtn">ğŸŒ EN</button>
        <button id="compactToggleBtn" class="btn btn-secondary" onclick="toggleCompactMode()" data-i18n="compactToggle">ğŸ—œï¸ Compact</button>
        <button id="fitToggleBtn" class="btn btn-secondary" onclick="fitToViewport()" data-i18n="fitBtn">ğŸ” Fit</button>
        {% if is_index %}
        <button class="btn btn-secondary" onclick="showHistory()" data-i18n="history">ğŸ“‹ Historial</button>
        <button id="clearAllBtn" class="btn btn-danger" onclick="clearAllOrders()" data-i18n="clearAll">ğŸ—‘ï¸ Borrar Pedidos</button>
        {% endif %}
    </nav>
</header>
<script>
    const translations = {
        es: {
            menu: "ğŸ›’ MenÃº",
            pedidos: "ğŸ“‹ Pedidos",
            analytics: "ğŸ“Š AnÃ¡lisis",
            drivers: "ğŸ›µ Repartidores",
            deliveries: "ğŸšš Entregas",
            langBtn: "ğŸŒ EN",
            title: "ğŸ— Sistema de Pedidos - RotiserÃ­a",
            history: "ğŸ“‹ Historial",
            clearAll: "ğŸ—‘ï¸ Borrar Pedidos",
            orderTitle: "Tu Pedido",
            total: "Total",
            customer: "Cliente",
            notes: "Notas",
            placeOrder: "Realizar Pedido",
            clear: "Limpiar",
            readyTitle: "ğŸšš Pedidos Listos para Entrega",
            noReadyOrders: "No hay pedidos listos",
            selectDriver: "-- Seleccionar Repartidor --",
            assign: "Asignar",
            selectAll: "Seleccionar Todos",
            ready: "âœ” Listo",
            selectDriverToast: "Selecciona un repartidor",
            selectOrderToast: "Selecciona al menos un pedido",
            assignedToast: "pedidos asignados a",
            completedToast: "Pedido completado",
            unassignedToast: "AsignaciÃ³n removida",
            complete: "Completar",
            unassign: "Desasignar",
            unassigned: "(sin asignar)"
        },
        en: {
            menu: "ğŸ›’ Menu",
            pedidos: "ğŸ“‹ Orders",
            analytics: "ğŸ“Š Analytics",
            drivers: "ğŸ›µ Drivers",
            deliveries: "ğŸšš Deliveries",
            langBtn: "ğŸŒ ES",
            title: "ğŸ— Order System - Delicatessen",
            history: "ğŸ“‹ History",
            clearAll: "ğŸ—‘ï¸ Clear Orders",
            orderTitle: "Your Order",
            total: "Total",
            customer: "Customer",
            notes: "Notes",
            placeOrder: "Place Order",
            clear: "Clear",
            readyTitle: "ğŸšš Orders Ready for Delivery",
            noReadyOrders: "No orders ready",
            selectDriver: "-- Select Driver --",
            assign: "Assign",
            selectAll: "Select All",
            ready: "âœ” Ready",
            selectDriverToast: "Select a driver",
            selectOrderToast: "Select at least one order",
            assignedToast: "orders assigned to",
            completedToast: "Order completed",
            unassignedToast: "Assignment removed",
            complete: "Complete",
            unassign: "Unassign",
            unassigned: "(unassigned)"
        }
    };
    // Add compact toggle translation key defaults if missing
    Object.keys(translations).forEach(lang => {
        translations[lang].compactToggle = translations[lang].compactToggle || (lang === 'es' ? 'ğŸ”§ Compacto' : 'ğŸ”§ Compact');
    });

    let currentLang = localStorage.getItem('lang') || 'es';

    function toggleLanguage() {
        currentLang = currentLang === 'es' ? 'en' : 'es';
        localStorage.setItem('lang', currentLang);
        applyLanguage();
    }

    function applyLanguage() {
        // Elements with data-i18n will be updated from translations
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            const text = translations[currentLang] && translations[currentLang][key];
            if (!text) return;
            el.textContent = text;
        });

        // Update page-specific elements only if they exist
        const mapping = {
            orderTitle: 'orderTitle',
            totalLabel: 'total',
            customerLabel: 'customer',
            notesLabel: 'notes',
            placeOrderBtn: 'placeOrder',
            clearBtn: 'clear',
            readyTitle: 'readyTitle'
        };
        Object.keys(mapping).forEach(id => {
            const el = document.getElementById(id);
            const key = mapping[id];
            if (el && translations[currentLang] && translations[currentLang][key]) el.textContent = translations[currentLang][key];
        });

        // Update driver select placeholder if present
        const bulkDriverSelect = document.getElementById('bulkDriverSelect');
        if (bulkDriverSelect && bulkDriverSelect.options[0]) bulkDriverSelect.options[0].text = translations[currentLang].selectDriver || bulkDriverSelect.options[0].text;

        if (typeof loadReadyOrders === 'function') loadReadyOrders();
    }

    // Compact mode: reduce paddings and make menu full-height
    function toggleCompactMode(){
        const cur = document.body.classList.toggle('compact');
        localStorage.setItem('ui.compact', cur ? '1' : '0');
        updateCompactButton();
    }

    function updateCompactButton(){
        const btn = document.getElementById('compactToggleBtn');
        if(!btn) return;
        const enabled = document.body.classList.contains('compact');
        btn.textContent = enabled ? (translations[currentLang].compactToggle + ' âœ“') : translations[currentLang].compactToggle;
    }

    function applyCompactMode(){
        const v = localStorage.getItem('ui.compact');
        if(v === '1') document.body.classList.add('compact'); else document.body.classList.remove('compact');
        updateCompactButton();
    }

    // Fit-to-viewport: scale the main container so everything fits without scrolling
    function fitToViewport(){
        const container = document.querySelector('.container');
        if(!container) return;
        // reset first
        document.documentElement.style.setProperty('--main-scale', '1');
        document.body.style.overflow = '';
        // measure natural height
        const totalH = document.documentElement.scrollHeight;
        const winH = window.innerHeight;
        let scale = 1;
        if(totalH > winH) scale = (winH - 8) / totalH; // small margin
        scale = Math.max(0.5, Math.min(1, scale));
        document.documentElement.style.setProperty('--main-scale', String(scale));
        if(scale < 1) document.body.style.overflow = 'hidden';
        localStorage.setItem('ui.fitScale', String(scale));
        updateFitButton();
    }

    function resetFit(){
        document.documentElement.style.setProperty('--main-scale', '1');
        document.body.style.overflow = '';
        localStorage.removeItem('ui.fitScale');
        updateFitButton();
    }

    function updateFitButton(){
        const btn = document.getElementById('fitToggleBtn');
        if(!btn) return;
        const scale = parseFloat(localStorage.getItem('ui.fitScale') || '1');
        btn.textContent = scale < 1 ? 'ğŸ” Fit âœ“' : translations[currentLang].fitBtn || 'ğŸ” Fit';
    }

    function applyFitFromStorage(){
        const s = localStorage.getItem('ui.fitScale');
        if(s){
            document.documentElement.style.setProperty('--main-scale', s);
            if(parseFloat(s) < 1) document.body.style.overflow = 'hidden';
        } else {
            document.documentElement.style.setProperty('--main-scale', '1');
        }
        updateFitButton();
    }

    // Apply language, compact mode and fit settings on load
    window.addEventListener('DOMContentLoaded', ()=>{ applyLanguage(); applyCompactMode(); applyFitFromStorage(); });

    function escapeHtml(text) {
        if (text == null) return '';
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }
</script>
